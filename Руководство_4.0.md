Модуль интеграции с Диадок

# Оглавление {#оглавление .TOC-Heading}

[**1.** Описание модуля [3](#описание-модуля)](#описание-модуля)

[**2.** Установка модуля [3](#установка-модуля)](#установка-модуля)

[**3.** Плагины модуля [6](#плагины-модуля)](#плагины-модуля)

[**4.** Особенности модуля
[10](#особенности-модуля)](#особенности-модуля)

[**5.** Начало работы с модулем [11](#_Toc180701167)](#_Toc180701167)

[**6.** Роли [11](#роли)](#роли)

[**7.** Представления [12](#представления)](#представления)

[**8.** Карточка настроек интеграции
[14](#карточка-настроек-интеграции)](#карточка-настроек-интеграции)

[**9.** Справочник контрагентов
[20](#справочник-контрагентов)](#справочник-контрагентов)

[**10.** Интеграционные аккаунты
[22](#интеграционные-аккаунты)](#интеграционные-аккаунты)

[**11.** Настройка процессов/маршрутов
[23](#настройка-процессовмаршрутов)](#настройка-процессовмаршрутов)

[**12.** Работа с МЧД [28](#работа-с-мчд)](#работа-с-мчд)

[**13.** Формализованные документы
[28](#формализованные-документы)](#формализованные-документы)

[**14.** Корректировочные и исправительные формализованные документы
[29](#корректировочные-и-исправительные-формализованные-документы)](#корректировочные-и-исправительные-формализованные-документы)

[**15.** Создание новой карточки для существующего сателлита
[32](#создание-новой-карточки-для-существующего-сателлита)](#создание-новой-карточки-для-существующего-сателлита)

[**16.** Файл визуализации и штамп ЭП
[33](#файл-визуализации-и-штамп-эп)](#файл-визуализации-и-штамп-эп)

[**17.** Тестирование [35](#тестирование)](#тестирование)

# Описание модуля

Возможности модуля интеграции с Диадоком:

-   прием, подписание, отправка формализованных и неформализованных
    документов;

-   создание формализованных документов и вручную, а так же путём
    загрузки XML-файла;

-   работа с корректировочными и исправительными формализованными
    документами;

-   работа с пакетами документов;

-   аннулирование документов, в том числе обработка запросов на
    аннулирование;

-   поддерживается работа из TESSA с несколькими организациями в Диадок
    одновременно;

-   поддержка массовой загрузки контрагентов и обработка запросов
    партнерства от контрагентов;

-   поддержка машиночитаемых доверенностей (далее -- МЧД);

-   загрузка файлов визуализации автоматически или вручную.

Данный функциональный блок устанавливается на любое проектное решение и
работает «из коробки» с настроенными процессами, представлениями, типами
карточек, справочниками.

Возможность настройки маппинга для реквизитов типов карточек
обеспечивает встраивание модуля в существующие в компании типы
карточек/документов.

Процессы реализованы на подсистеме маршрутов и визуальном конструкторе
процессов Workflow Engine (далее WFE).

Модуль работает как в толстом клиенте (далее -- ТК), так и в web-клиенте
(далее -- ЛК) на версии 3.6 с последним патчем.

# Установка модуля

## Установка расширений

### Установка дополнительных компонентов

Установить на сервер приложений КриптоПро CSP
<https://www.cryptopro.ru/products/csp?ysclid=ln07ejprm7725839556> через
сайт или при помощи средства Диагностики на сайте Диадок.

Он необходим для обеспечения корректной работы с сервисами криптографии
на сервере.

Файлы поставки модуля содержат папки с расширениями, конфигурацией и
руководством.\
Расширения находятся в папке {Путь к файлам}/Build/Bin и включают файлы
для веб-клиента, desktop клиента, хроноса и web-сервера.\
Конфигурация с схемой данных, представлениями, карточками, локализацией
находятся в папке {Путь к файлам}/Configuration\
В папке {Путь к файлам}/Build/Scripts содержаться SQL скрипты
применяемые в случае обновления версии платформы, к примеру с 3.6-18 на
4.0.х. (рассказать про них)\
Папка {Путь к файлам}/Docs включает руководство к модулю и файл с
списком изменений в патчах.

Перед установкой расширений рекомендуется остановить пул приложений для
вашего сервера.\
Здесь написать про необходимость Redis....

### Установка расширений для веб-сервера и веб-клиента

Из папки сборки {Сборка модуля}/Build/Bin/Tessa.Module.Diadoc.Server
скопировать файлы в папку {Путь к веб-серверу}/web/extensions:

-   Tessa.Module.Diadoc.Shared.dll;

-   Tessa.Module.Diadoc.Server.dll;

-   DiadocApi.dll.

В файле {Путь к веб-серверу}/web/extensions/extensions.xml добавить
строки:

\<include file=\"Tessa.Module.Diadoc.Shared.dll\" /\>

\<include file=\"Tessa.Module.Diadoc.Server.dll\" /\>

Из папки сборки {Сборка модуля}/Build/Bin/ Web bin скопировать файлы
расширений веб-клиента в папку {Путь к
веб-серверу}/web/wwwroot/extensions.

Убедиться, что в app.json (который расположен в веб-сервере) включен
флаг \"CryptoProPluginEnabled\": true, если планируется работа из ЛК.

### Установка расширения для Chronos 

Из папки сборки {Сборка модуля}/Build/Bin/Tessa.Module.Diadoc.Server
скопировать файлы в папку {Путь к веб-серверу}/web/extensions:

-   Tessa.Module.Diadoc.Sharer;

-   Tessa.Module.Diadoc.Server;

-   DiadocApi.dll.

В файле {путь к папке с Chronos}/extensions/extensions.xml добавить
строки:

\<include file=\"Tessa.Module.Diadoc.Shared.dll\" /\>

\<include file=\"Tessa.Module.Diadoc.Server.dll\" serverOnly=\"true\"
/\>

Если Chronos уже развернут с расширениями и все настроено правильно в
соответствии с руководством (см. руководство по настройке Chronos ), то
будет существовать папка {путь к папке с
Chronos}\\Plugins\\Tessa.Extensions.Chronos, в нее необходимо
скопировать:

-   папку из сборки Chronos модуля «{Сборка
    модуля}/Build/Bin/Tessa.Module.Diadoc.Chronos/configuration/»и
    выполнить слияние содержимого;

-   Файл сборки Tessa.Module.Diadoc.Chronos.dll из «{Сборка
    модуля}/Build/Bin/Tessa.Module.Diadoc.Chronos/»

### Установка расширений ТК и TessaAdmin

Из папки сборки {Сборка модуля}/Build/Bin/Tessa.Module.Diadoc.Client
скопировать файлы в папку {путь к папке
приложения}/tessaclient/extensions:

-   Tessa.Module.Diadoc.Client;

-   Tessa.Module.Diadoc.Shared.

В файл {путь к папке приложения}/tessaclient/extensions/extensions.xml
добавить строки:

\<include file=\"Tessa.Module.Diadoc.Shared.dll\" /\>

\<include file=\"Tessa.Module.Diadoc.Client.dll\" clientOnly=\"true\"
/\>

После внесения изменений необходимо выполнить публикацию приложений на
сервер из папок клиентских приложений.

После установки расширений снова запустите пул приложений сервера.

## Импорт конфигурации

### Импорт конфигурации модуля

Стандартно импортировать всю конфигурацию модуля:

-   Локализация (через импорт файла) из папки {Сборка
    модуля}/Configuration/Localization;

-   Схема (через импорт библиотеки) из папки {Сборка
    модуля}/Configuration/Scheme/Diadoc;

-   Представления с заменой прав из папки {Сборка
    модуля}/Configuration/Views/Diadoc;

-   Типы карточек (через импорт типов), в том числе диалоги и задания из
    папки {Сборка модуля}/Configuration/Types;

-   Библиотеку карточек (через импорт карточек) из папки {Сборка
    модуля}/Configuration/Cards/Diadoc.jcardlib;

-   Карточку настроек интеграции Диадок (через импорт карточки) из папки
    {Сборка модуля}/Configuration/Cards/Settings

-   Рабочие места с заменой прав из папки {Сборка
    модуля}/Configuration/Workplaces;

-   ~~Карточки (желательно через .cardlib для исключения нарушения
    установленного порядка импорта).~~

~~Обратить внимание, что в сборке будет две библиотеки карточек, одна
для MS, другая для PG, и нужно выбрать подходящую в зависимости от
используемой СУБД.~~ Это описание для 3.6-18.

### Изменения типовой и проектной конфигурации

Если на проекте есть изменения в карточке «Настройки типового решения»,
то вместо импорта соответствующей карточки из модуля необходимо изменить
ее вручную:

-   в таблицу «Типы карточек» добавить запись с «Типом карточки» -
    Неформализованный документ, установить флаг \"Использовать типы
    документов\";

-   в таблицу \"Типы карточек\" добавить запись с \"Типом карточки\" -
    Пакет документов, установить флаг \"Использовать маршруты\".

Для того, чтобы ссылки на документы пакета открывались в ЛК, необходимо
в карточке \"Настройки сервера\" ввести в поле \"Базовый адрес
web-клиента для уведомлений и виртуальных файлов\" адрес сервера, по
которому расположен сервер.

Процесс получения информации о том, что вам пришёл запрос партнёрства в
Тесса реализован через получение задания в карточке КА, от которого
поступил запрос. Чтобы увидеть задание, необходимо в приложении
TessaAdmin выставить флаг для карточки \"Partner\" (в Dictionaries)
\"Разрешить задания\". Для того, чтобы задания по карточке контрагента
были доступны в подсистеме маршрутов, необходимо в карточке настроек
типового решения в типе карточки \"Контрагент\" разрешить использовать
маршруты.

Если предполагается работа с категориями подписываемых файлов,
потребуется дозаполнить справочник категорий и выбрать необходимую
категорию в поле этапа маршрута процесса \"Подписание и отправка\". Так
же в приложении TessaAdmin установить для секции Файлы в карточке
необходимого документа флаг \"Использовать категории\" (касается
вторичных и WFE процессов).

# Плагины модуля

## Плагин синхронизации

Название в коде -- LoadDocumentsPlugin.

Данный плагин отвечает за две функции:

-   загрузка новых документов из Диадок;

-   обновление существующих документов в TESSA, если по ним были события
    в Диадок.

В указанное время плагин опрашивает Диадок о наличии новых поступивших
документов по каждому из Интеграционных Аккаунтов (далее -- ИА.
Подробное описание ИА в разделе 9). Если документов нет, то сразу
переходит к обработке событий, если документы были, то начинает
загружать их в TESSA. После успешной обработки новых документов плагин
опрашивает Диадок о наличии событий по существующим документам для
каждого ИА, затем в зависимости от вида события обрабатывает каждое
раздельно, например, прикладывает поступившие подписи к файлу, меняет
статусы Диадок при аннулировании и т.д.

В целях поддержания целостности плагин сначала загружает новые
документы, а только затем начинает обрабатывать поступившие события для
избегания ситуации, когда плагин находит событие по документу, который
еще не был создан в TESSA.

Плагин «запоминает» необработанные документы и события, например в
случае разрыва соединения или же других необработанных исключениях.
Перед основной синхронизацией плагин сначала попытается обработать
документы и события из тех, что не были обработаны ранее.

Настройки данного плагина:

-   Частота срабатывания -- указывается в LoadDocumentsPlugin.xml, по
    умолчанию раз в минуту.

-   Возможность конкуренции -- указывается в LoadDocumentsPlugin.xml,
    изначально равна disallowConcurrency=\"true\" и менять нельзя, это
    может привести к поломке работы плагина. Плагин всегда должен иметь
    не более одного запущенного процесса.

-   Настройки интеграции -- плагин считывает таблицу «Настройки
    интеграции» из карточки «Настройки интеграции Диадок» и выполняет
    подходящие действия, например, можно указать создание карточки при
    поступлении какого-либо вида документа Диадок. Также можно указать
    запуск различных процессов на обоих подсистемах при поступлении того
    или иного события Диадок. Подробное описание таблицы «Настройки
    интеграции» в разделе 7.1.1

## Плагин отправки

Название в коде -- SendDocumentPlugin.

Данный плагин отвечает за отправку документов в Диадок.

Плагин запускается один раз и начинает циклом считывать все активные
операции и ищет операции с типом отправки документа в Диадок.
Формирование активной операции происходит после успешного завершения
этапа «Подписание и отправка Диадок». Если находит, то начинает
обрабатывать операцию.

Обработка операции представляет из себя формирование объекта для
отправки в Диадок на основе указанной карточки и его сателлита (карточки
сателлиты в TESSA -- это такие карточки, которые сопровождают основную
карточку и дополняют ее некоторой информацией) Диадок. Если операции не
нашлись, то плагин ожидает некоторое время перед тем, как прочитать
записи активных операций еще раз.

Настройки данного плагина:

-   Частота срабатывания -- указывается в SendDocumentPlugin.xml и
    отвечает за то, как быстро плагин перезапустится, если по какой-либо
    причине он сломался. При корректной настройке плагин запустится лишь
    один раз, а дальше раз в указанно время будет проверять, существует
    ли уже процесс, и перезапускаться только в случае, если процесса
    нет. Не рекомендуется менять.

-   Возможность конкуренции -- указывается в SendDocumentPlugin.xml,
    изначально равна disallowConcurrency=\"true\" и менять не
    рекомендуется.

## Плагин синхронизации контрагентов

Название в коде -- SyncPartnersPlugin.

Данный плагин отвечает за две функции:

-   загрузка контрагентов;

-   обновление контрагентов.

Плагин схож с плагином отправки документов, он так же запускается один
раз и в цикле, считывает активные операции, пока не найдет операцию с
типом загрузки или обновления контрагентов. Если операция не найдена, то
плагин какое-то время ожидает перед тем, как попытаться считать записи
еще раз. Если операция нашлась, то плагин начинает ее обработку.

Обработка операции зависит от типа операции:

-   при режиме «Загрузка» плагин для каждого из ИА опросит Диадок о
    списке его контрагентов в статусе «Активен», а затем начнет
    загружать их в TESSA. Если контрагент не найден, то создается новая
    карточка контрагента, в карточку заполняются все известные реквизиты
    полученного контрагента;

-   при режиме «Обновление» плагин будет опрашивать Диадок только по тем
    Контрагентам, которые уже есть в БД TESSA и имеют статус «Активен».
    Плагин начнет обновлять их реквизиты, если они не совпали в TESSA и
    Диадок. Так же в этом режиме происходит смена статусов партнёрства
    между КА в случае блокировки на «Заблокирован».

Формирование операции происходит после нажатия одной из кнопок в
карточке «Настройки интеграции Диадок», вкладка «Настройки
синхронизации»:

-   Загрузить контрагентов;

-   Обновить контрагентов.

Настройки плагина отсутствуют, настройки конфигурации плагина xml менять
не рекомендуется.

##  Плагин мониторинга заявок партнерства

Название в коде -- MonitoringAcquireRequestsPlugin.

Данный плагин отвечает за обработку входящих и исходящих заявок
партнерства по контрагентам в Диадок.

Плагин запускается раз в указанный промежуток времени и опрашивает
Диадок по всем заявкам партнерства каждого из ИА. При обработке
исходящих заявок партнерства плагин обновляет статус контрагента
относительно действующего ИА согласно ответу, полученному от Диадок, и
содержащему текущий статус партнерства. Исходящие заявки партнерства
формируются из TESSA. При нахождении новой входящей заявки или ответа по
старой исходящей, плагин выполнит действия в соответствии с настройками:

-   Частота срабатывания -- указывается в
    MonitoringAcquireRequestsPlugin.xml и отвечает за то, как часто
    будет срабатывать данный плагин. Изначально указано 5 минут, можно
    менять.

-   Возможность конкуренции -- указывается в
    MonitoringAcquireRequestsPlugin.xml, изначально равна
    disallowConcurrency=\"true\", менять не рекомендуется, это может
    привести к сбоям в работе плагина.

-   При нахождении новой входящей заявки плагин выполнит действия в
    соответствии с настройками в таблице «Настройки интеграции» карточки
    «Настройки интеграции Диадок» с типом события «Поступил запрос
    партнерства от контрагента». При необходимости создания карточки КА,
    в первую очередь происходит проверка наличия существующего КА в
    справочнике КА в TESSA, и если контрагент найден, то производится
    обновление/заполнение недостающих данных, но не создание новой
    карточки. Поиск выполняется по параметрам: идентификатор участника,
    ИНН, КПП. Если по этим параметрам КА в справочнике не найден
    (отсутствуют или неполные), то создается новая карточка КА.

## Плагин загрузки файлов визуализации

Название в коде -- DownloadFileVisualizationPlugin.

Данный плагин осуществляет загрузку из Диадок файлов визуализации:
\*.pdf или \*.zip.

Плагин запускается один раз и начинает циклом считывать все активные
операции, и ищет там операции с типом загрузки файлов визуализации.
Такие операции могут быть созданы плагином синхронизации при загрузке
документов, если включен соответствующий флаг в настройках интеграции
(указать ссылку на раздел, где описана карточка настроек интеграции и
этот флаг). Если находит, то начинает обрабатывать операцию.

В зависимости от режима работы данный плагин может загрузить из Диадок
либо документ в формате pdf, либо полностью архив.

Настройки данного плагина:

-   Частота срабатывания -- указывается в
    DownloadFileVisualizationPlugin.xml и отвечает за то, как быстро
    плагин «перезапустится», если по какой-либо причине он сломался. При
    корректной настройке плагин запустится лишь один раз, а дальше раз в
    указанно время будет проверять, существует ли уже процесс, и
    перезапускаться только в случае, если процесса нет. Не рекомендуется
    менять.

-   Возможность конкуренции -- указывается в
    DownloadFileVisualizationPlugin.xml, изначально равна
    disallowConcurrency=\"true\", можно менять, если планируется
    масштабировать данный плагин..

## Плагин конвертации в pdf и проставления штампов

Название в коде -- DiadocFileConversionPlugin.

Плагин необходим для работы заданий «Конвертация для Диадок» и отвечает
за конвертацию основного файла в .pdf с простановкой штампов подписей.
Данное действие необходимо для обеспечения работы этапа маршрута и
кубика WFE «Конвертация для Диадок».

Плагин запускается один раз и циклом ищет активные операции типа
«Конвертация для Диадок» (DiadocFileConvertion). Если такая операция
найдена, плагин ищет основной файл для неформализованного документа или
файл визуализации для формализованного документа, затем при
необходимости конвертирует его в .pdf и проставляет штампы с данными об
электронных подписях, прикрепленных к файлу. Полученные файлы
сохраняются в указанную в настройках задания «Конвертация для Диадок»
категорию. По окончании работы плагин завершает задание на конвертацию и
записывает результат в историю заданий, позволяя документу двигаться
дальше по маршруту [(Подробнее в разделе 15.2)](#_Конвертация_файла_и).

## Плагин загрузки информации по сотрудникам МЧД

Название в коде -- PoAEmployeesPlugin.

Плагин необходим для загрузки информации по сотрудникам МЧД, которые
указаны в сателлите ИА, в таблице «МЧД организации».

Плагин запускается каждый день, получает список всех интеграционных
организаций и для каждой интеграционной организации получает список всех
сотрудников. Создает или обновляет информацию в таблице «МЧД
организации» для сотрудников, которые указаны в настройках интеграции
Диадок, в поле «Сотрудники, для которых выполнять синхронизацию МЧД». С
помощью полей маппинга в настройке интеграции Диадок «Секция» и «Поле» в
блоке «Логин сотрудника для сопоставления пользователя Диадок» можно
настраивать поле, откуда из карточки сотрудника будет взят реквизит для
логина в Диадок. По умолчанию настроено поле «E-mail».

В строке таблицы заполняет следующую информацию в соответствии с
требованиями в Диадок:

-   Идентификатор пользователя;

-   Название пользователя;

-   Идентификатор пользователя Диадок;

-   Должность.

## Плагин синхронизации МЧД

Название в коде -- PoASynchronizePlugin.

Плагин, запускающийся один раз в день и выполняющий отправку в Диадок
информации по МЧД:

-   Для всех организаций, по всем строкам МЧД со статусом «Ожидает
    синхронизации» у которых есть идентификатор сотрудника,
    идентификатор доверенности и ИНН, выполняет регистрацию и привязку
    доверенности в Диадоке, меняя статус на «Привязана».

-   Для всех удаленных из таблицы МДЧ, которые ранее были в статусе
    «Привязана», отправляется в Диадок информация о том, что нужно
    отвязать.

# Особенности модуля

1.  Модуль интеграции с Диадоком будет работать только в том случае,
    если есть хоть одна карточка контрагента с выставленным флагом
    «Интеграционный аккаунт».

2.  Для корректного запуска процесса, указанного в настройке Действий в
    карточке «Настройки интеграции Диадок» необходимо, чтобы процесс был
    доступен роли System.

3.  Плагин синхронизации производит [первичную]{.underline} загрузку от
    даты начала синхронизации, указанной в ИА, либо от даты, указанной в
    карточке «Настройки интеграции Диадок», если у данного ИА дата не
    установлена. В конце синхронизации плагин запоминает для данного ИА
    идентификаторы последнего загруженного документа и последнего
    обработанного события, и последующие синхронизации производит от
    этих идентификаторов. Таким образом после успешной первичной
    загрузки удаление даты начала синхронизации не приведет к загрузке
    более старых документов.

4.  Если после установки флага «Участвует в документообороте Диадок» для
    типа документа или типа карточки в данных карточках не появляется
    тулбар Диадок, то необходимо подождать некоторое время, чтобы
    приложение пересчитало кеш метаданных типов, либо перезагрузить пул
    приложений.

5.  Для правильной настройки ИА данной организации необходимо в Диадок
    добавить «административного пользователя», от лица которого
    производится интеграция с разных ИА. Обязательно нужно убедиться,
    что у данного пользователя для данной организации настроены права
    доступа, в том числе: создавать и редактировать документы и
    черновики, подписывать документы, видеть списки контрагентов и
    работать с ними.

6.  После изменения настроек интеграции необходимо перезапустить пул
    приложения и Chronos.

7.  Для того, чтобы задания по процессам, входящим в типовую поставку
    модуля (например, задание на принятие решение по запросу партнёрства
    с контрагентом), были на русском языке, а не английском, необходимо
    от имени администратора в справочнике сотрудников найти учетную
    запись «System» (показать скрытые в настройках фильтрации) и в ней
    выставить русский язык.

8.  Присутствует возможность кодом переопределить формирование текста в
    карточке документа в баллоне, расположенном справа.

9.  Для того, чтобы новая созданная карточка контрагента отобразилась в
    представлении «Контрагенты» необходимо при заполнении реквизитов
    зайти единожды в реквизиты Диадок карточки (можно без заполнения
    данных). Если не выполнить рекомендацию, контрагент создастся, но
    будет только в БД и перейти на него будет возможно только через id.

<!-- -->

5.  []{#_Toc180701167 .anchor}Начало работы с модулем

<!-- -->

1.  Создаём карточку контрагента, который будет выступать в роли
    интеграционного (сокращённо ИА). В качестве КА может выступать любой
    из имеющихся в ЛК Контур.Диадок. Относительно него будут происходить
    синхронизации документов и других контрагентов. Заполняем поля
    Краткое наименование и Полное наименование. В настройках Диадок КА
    заполнить поле «Идентификатор участника ЭДО», установить флаг
    «Интеграционный аккаунт». Установить флаг «Основной аккаунт» у ИА
    или у одного из ИА, если их несколько. При необходимости
    устанавливаем дату -- «Дата начала обмена», от которой будет
    происходить синхронизация документов для конкретного ИА. Если дата
    не указана в карточке, будет учитываться дата, указанная в карточке
    \"Настройки интеграции Диадок\" (Действует на всех ИА, если их
    несколько).

2.  Настраиваем необходимые в работе типы документов для использования в
    документообороте. Устанавливаем флаг «Участвует в документообороте
    Диадок» в карточке типа документа и, если не выставлен, флаг
    «Использовать маршруты».

3.  Произвести синхронизацию контрагентов, относительно ИА. В карточке
    Настройки интеграции Диадок, во второй вкладке - Настройки
    синхронизации (кнопка Загрузить контрагентов). При необходимости
    обновления данных по загруженным контрагентам, произвести
    Обновление - кнопка Обновить.

4.  Для отображения необходимых для работы тайлов в левой панели, такие
    как Аннулирование, Подписание и отправка и др. проверить включён ли
    необходимый вам тип/вид документа в поле Типы карточки процесса
    (касается вторичных и WFE процессов).

5.  Для корректного приёма документов в модуль рекомендуется проверить и
    откорректировать (при необходимости) правила интеграции в карточке
    Настройки интеграции Диадок. Используемый в работе тип(ы) документа
    должен(ы) присутствовать в правиле создания документа(ов).
    Аналогично и для других правил интеграции.

# Роли

Просмотреть список всех карточек ролей можно из рабочего места
«Администратор» в представлении «Роли».

В модуле настроены следующие роли:

  ------------------------------------------------------------------------
  **Название роли**       **Тип**            **Описание**
  ----------------------- ------------------ -----------------------------
  Заполнение информации   Статическая роль   Роль позволяет редактировать
  об МЧД                                     таблицу МЧД в сателлите
                                             контрагента модуля Диадок

  Заполнение контрагентов Статическая роль   Роль позволяет редактировать
  Диадок                                     все поля сателлита
                                             контрагента

  Обработка запросов по   Статическая роль   На данную роль отправляются
  контрагентам                               задания для принятия решения
                                             по запросу приглашения к
                                             обмену Диадок. Данный процесс
                                             входит в типовую поставку
                                             модуля, но вы можете его
                                             изменить
  ------------------------------------------------------------------------

# Представления

Все описанные ниже представления расположены на отдельном рабочем месте
«Диадок». Не обязательно на проекте использовать представления именно в
рамках этого рабочего места, с помощью TessaAdmin можно все
представления перенести на удобные вам рабочие места.

## Документы Диадок

В представлении отображается перечень всех документов Диадок во всех
состояниях, у которых есть сателлит для взаимодействия с Диадоком.

<figure>
<img src="media/image1.png" style="width:6.49653in;height:0.46389in" />
<figcaption><p>Рисунок 1. Представление «Документы
Диадок»</p></figcaption>
</figure>

## Пакеты документов

В представлении отображается перечень всех пакетов документов Диадок во
всех состояниях и всех направлений (входящие и исходящие).

<figure>
<img src="media/image2.png" style="width:6.49653in;height:0.87917in"
alt="Изображение выглядит как текст, Шрифт, снимок экрана, число Автоматически созданное описание" />
<figcaption><p>Рисунок 2. Представление «Пакеты
документов»</p></figcaption>
</figure>

## Сбой отправки документов

В представлении отображаются документы, которые не удалось отправить, и
у которых статус обработки Диадок - «Сбой отправки».

<figure>
<img src="media/image3.png" style="width:6.49653in;height:0.6375in" />
<figcaption><p>Рисунок 3. Представление «Сбой отправки
документов»</p></figcaption>
</figure>

## Сбой доставки документов

В представлении отображаются документы, которые были успешно отправлены,
но Диадок ответил ошибкой, и у которых статус обработки Диадок -- «Сбой
доставки».

<figure>
<img src="media/image4.png" style="width:6.49653in;height:0.60278in" />
<figcaption><p>Рисунок 4. Представление «Сбой доставки
документов»</p></figcaption>
</figure>

## История операций Диадок

В представлении отображается история взаимодействия с Диадоком по
каждому документу. В отдельной строке запись при поступлении нового
документа, подписи по исходящему документу, входящего запроса на
аннулирование, принятия или отказа по исходящему запросу аннулирования.

![Изображение выглядит как текст, снимок экрана, Шрифт, число
Автоматически созданное
описание](media/image5.png){width="6.496527777777778in"
height="0.9326388888888889in"}

Рисунок 5. Представление «История операций Диадок»

## МЧД организаций

В представлении отображается список всех сотрудников, у которых есть
актуальная МЧД, и которые добавлены в таблицу «МЧД организации» в
карточках ИА.

<figure>
<img src="media/image6.png" style="width:6.49653in;height:0.77986in" />
<figcaption><p>Рисунок 6. Представление «МЧД
организаций»</p></figcaption>
</figure>

## Справочники

В представлении присутствуют справочники:

-   Статусы документов Диадок;

-   Виды документов Диадок;

-   Типы договоров;

-   Статусы обработки Диадок;

-   Контрагенты. Подробное описание справочника в разделе 8;

-   Интеграционные аккаунты. Подробное описание справочника в разделе 9;

-   Ошибки синхронизации документов;

-   Ошибки обработки событий.

<figure>
<img src="media/image7.png" style="width:6.49653in;height:2.42986in"
alt="Изображение выглядит как текст, число, программное обеспечение, снимок экрана Автоматически созданное описание" />
<figcaption><blockquote>
<p>Рисунок 7. Представление «Справочники»</p>
</blockquote></figcaption>
</figure>

# Карточка настроек интеграции

Открыть карточку настроек интеграции можно из меню системы -\> Настройки
-\> Настройки интеграции Диадок.

<figure>
<img src="media/image8.png" style="width:6.49653in;height:4.06944in" />
<figcaption><p>Рисунок 8. Открытие карточки настроек интеграции
Диадок</p></figcaption>
</figure>

## Вкладка «Основные настройки»

-   URL Диадок -- адрес Диадока, по умолчанию <https://www.diadoc.ru>,
    используется для формирования ссылок на документы Диадок.

-   URL API Диадок -- URL адрес по которому идет взаимодействие с API
    Диадок при помощи HTTPS, по умолчанию
    <https://diadoc-api.kontur.ru>.

-   Идентификатор разработчика -- идентификатор разработчика для
    возможности интеграции по API. Получить его можно у Контур.Диадок
    (платный сервис Контур.Диадок).

-   Максимальный размер файла для отправки, МБ -- ограничение на
    максимальный размер файла, который допустимо отправлять в Диадок.

-   Логин -- логин административной учетной записи для подключения к
    Диадоку. Данная учетная запись должна иметь доступ ко всем
    интеграционным аккаунтам (ящикам Диадок), для которых должна
    выполняться интеграция.

-   Пароль -- пароль административной учетной записи для подключения к
    Диадоку.

-   Использовать прокси -- флаг (по умолчанию false).

-   Адрес прокси -- адресс прокси-сервера. Контрол скрыт, если снят флаг
    «Использовать прокси».

-   Логин для прокси -- логин для подключения к прокси-серверу. Контрол
    скрыт, если снят флаг «Использовать прокси».

-   Пароль для прокси -- пароль учетной записи для подключения к
    прокси-серверу. Контрол скрыт, если снят флаг «Использовать прокси».

-   Сотрудники, для которых выполнять синхронизацию МЧД -- для
    сотрудников указанных ролей будет выполняться синхронизация
    информации по МЧД (загрузка информации по учетным записям
    организации Диадок), если поле оставить пустым, то синхронизация
    будет выполняться по всем пользователям, зарегистрированным в
    Диадоке.

-   Дата начала обмена -- дата, начиная с которой из Диадока забираются
    документы (дата создания/получения документов в Диадок). Необходимо
    при включении модуля, чтобы не затянуть обработанные документы за
    предыдущие годы.

-   Обмен только с известными контрагентами -- при выставлении флага, в
    представлении для выбора контрагентов, кому необходимо отправить
    документ в Диадок, не будут доступны контрагенты, с которыми не
    установлено партнерство.

-   Тип загрузки файлов визуализации -- настройка, позволяющая при
    переходе документа в конечный статус Диадок (Документооборот
    завершен, Аннулирован, Подписан, Подписан контрагентом)
    автоматически загрузить PDF файл визуализации ЭП или полный архив.

-   Категория загруженных файлов визуализации -- категория, в которую
    необходимо размещать загруженный PDF файл визуализации или файл
    полного архива.

-   Категория файлов для входящих документов -- категория, в которую
    необходимо размещать загруженные файлы документов, поступивших из
    Диадока.

-   Блок полей «Логин сотрудника для сопоставления пользователя
    Диадок» - Секция и Поле, откуда необходимо брать данные учетной
    записи сотрудника для маппинка сотрудника TESSA и учетной записи
    Диадок. По умолчанию настроен маппинг по полю «E-mail» карточки
    сотрудника.

### Таблица «Настройки интеграции»

Таблица предназначена для настройки обработки поступивших из Диадок
событий. На каждый вид поступившего события и каждый вид документа
Диадок можно настроить выполнение тех или иных действий.

<figure>
<img src="media/image9.png" style="width:6.49653in;height:1.80347in" />
<figcaption><p>Рисунок 9. Таблица «Настройки
интеграции»</p></figcaption>
</figure>

Поля таблицы:

-   Описание -- описание добавленной настройки. Рекомендуется указывать
    полное и подробное описание.

-   Действие -- действие, которое необходимо выполнить системе при
    поступлении события, удовлетворяющего всем условиям (описаны ниже).
    Возможные варианты:

    -   Создать карточку -- будет создана новая карточка. Данное
        действие актуально только для тех событий, где предполагается
        создание карточки, например, «Поступил входящий документ».

    -   Создать карточку и запустить процесс -- аналогично предыдущему,
        только помимо создания карточки система запустит указанный
        процесс.

    -   Запустить процесс -- будет запущен указанный процесс.

    -   Не указано -- нет необходимости создавать карточку и/или
        запускать процесс, но может быть настроена дополнительная
        обработка.

-   Тип карточки -- заполняется в случае, если выбрано действие создания
    карточки, указывается карточку какого типа необходимо создать (с
    помощью условий можно настроить, чтобы разные типы карточек
    создавались при поступлении разных видов документов Диадок).
    Очищается, если заполнено «Шаблон карточки».

-   Идентификатор процесса -- указывается идентификатор процесса,
    который необходимо запустить в системе при поступлении события,
    удовлетворяющего всем условиям. Можно указать идентификатор карточки
    вторичного процесса или карточки процесса (WFE). Данное поле
    актуально заполнять только в случае, если выбрано действие «Создать
    карточку и запустить процесс» или «Запустить процесс».

-   Использовать скрипт -- скрипт для дополнительной обработки
    поступившего события.

Имеется возможность скомпилировать как отдельный, так и все имеющиеся
скрипты в правилах интеграции. Результат компиляции будет записываться в
кэш (таблица в БД), который потом будет использоваться в вызывающих
методах. Так же компиляция произойдёт автоматически при внесении
изменений в скрипт и в последующем срабатывании правила интеграции. При
наличии ошибок в скрипте, они выводятся во всплывающем окне. А при
наступлении события по правилу с ошибками в скрипте система
проинформирует об этом в логах и в представлении «Ошибки синхронизации
документов».

-   Список условий -- таблица для указания условий, при выполнении
    которых система обработает данную запись таблицы настроек
    интеграции. Для добавления условий доступны четыре типа условий:

    -   Необходимо подписание входящего документа -- при выборе данного
        условия, оно сработает в случае, если по поступившему документу
        Диадок требуется подписание организацией. Флаг «Инвертировать
        условие» выставляется в случае, если нам необходимо условие по
        признаку, что подписание документа организацией не требуется.

    -   По виду документа Диадок -- необходимо выбрать виды документов
        Диадок, для которых должно в системе сработать данное условие.
        Флаг «Инвертировать условие» означает, что условие сработает для
        всех видов документов Диадок, кроме указанных в условии.

    -   По виду события интеграции Диадок -- выбирается событие, для
        которого должно сработать условие.

    -   По функции документа Диадок -- выбирается функция УПД:
        Передаточный документ, Счет-фактура или Счет-фактура и
        передаточный документ.

> Все указанные условия объединяются логическим ИЛИ, т.е. для выполнения
> действий по настройкам строки в данной таблице необходимо, чтобы все
> указанные условия удовлетворяли поступившим из Диадок данным.
>
> Для типа условия «Поступил запрос партнёрства от контрагента»
> необходимо указать действие «Создать карточку и запустить процесс»,
> чтобы в случае отсутствия КА в Тесса, плагин мониторинга заявок создал
> карточку. Для уже существующих организаций будет запускаться только
> вторичный процесс.\
> По типу условия «Поступил входящий документ» рекомендуется создать 2
> правила: для Неформализованных и Формализованных документов.\
> Типа условия «Поступил ответ на запрос партнерства с контрагентом»
> работает с действием «Запустить процесс». Правило срабатывает на ответ
> по исходящему запросу партнёрства отправленного из Тесса и изменением
> его с «В обработке» на «Активен» или «Заблокирован» в Диадок.

### Таблица «Маппинг»

Система формирует документ для отправки в Диадок на основе сателлита.
Для избегания заполнения реквизитов документа непосредственно в
сателлите, можно заполнить таблицу маппинга, которая предназначена для
автоматического переноса значений реквизитов из карточки документа в
сателлит (диалог, открываемый по кнопке «Показать реквизиты» на тулбаре
в меню Диадок). Таблица маппинга находится в карточке настоек интеграции
Диадок.

![](media/image10.png){width="6.122624671916011in"
height="1.932014435695538in"}

**Рисунок. Таблица «Маппинг»**

Для каждого реквизита заполняется секция и поле, для которых будет
выполнен маппинг с реквизитом в сателлите. Перед тем, как перенести
значение, проводится проверка не только на наличие самого маппинга и
секции к нему в основной карточке, но и наличие секции нужного реквизита
в самом сателлите. Узнать секцию и поле карточки для реквизита можно с
помощью TessaAdmin:

<figure>
<img src="media/image11.png" style="width:6.49653in;height:3.09306in" />
<figcaption><p>Рисунок 10. Получение информации из
TessaAdmin</p></figcaption>
</figure>

Для каждого параметра маппинга в версии 4.0.х и выше появилась
возможность указывать для каких типов карточек или типов документов или
групп типов документов должна применяться настройка реквизита (колонка
«Типы документов»). Среди групп представлены «Неформализованные
документы» и «Участвуют в документообороте Диадок». Пустое значение в
колонке «Типы документа» означает применение настройки маппинга для
любых типов, включённых в документооборот Диадок.

![](media/image12.png){width="5.357638888888889in"
height="2.463888888888889in"}

Рисунок . Выбор типа документа для реквизита маппинга.

Надо помнить, что если есть необходимость в обязательных полях и
реквизитах в документе, то не должно быть обязательных полей, которые не
заполняются автоматически (в коде расширений, в процессах) и для которых
не настроен маппинг. Иначе плагин синхронизации не создаст входящий
документ и в логах будет ошибка о незаполненном поле. В типовой поставке
примером может служить тип документа «Договор» и его обязательное поле
«тема».

## Вкладка «Настройки синхронизации»

Данная вкладка предназначена для первоначальной загрузки информации по
контрагентам, а также для загрузки информации по контрагентам, для
которых указан идентификатор ЭДО. В первую очередь обновляется
информация по ИА.

<figure>
<img src="media/image13.png" style="width:6.49653in;height:2.34861in"
alt="Изображение выглядит как текст, веб-страница, Веб-сайт, Шрифт Автоматически созданное описание" />
<figcaption><p>Рисунок 12. Вкладка «Настройка
синхронизации»</p></figcaption>
</figure>

**ВАЖНО!** Синхронизация контрагентов не выполняется автоматически (в
периодическом режиме), а только запускается вручную. Предполагается, что
после первоначальной загрузки контрагентов вся работа с контрагентами
(запросы партнерства, поиск и добавление новых) выполняется только из
системы TESSA, без внесения изменений в личном кабинете Диадока.

Доступные кнопки:

-   Загрузить контрагентов -- при нажатии на кнопку для всех
    интеграционных аккаунтов будет выполнена загрузка все контрагентов,
    с которым установлены партнерские отношения в Диадоке. При этом при
    загрузке информации система для каждого контрагента, которого
    необходимо загрузить система последовательно выполнит проверки:

    -   выполнит поиск наличия такого контрагента по идентификатору
        ящика или участника ЭДО, если такой будет найден, то обновит
        информацию по нему (информацию, к каким интеграционным аккаунтам
        относится данный контрагент),

    -   выполнит поиск наличия такого контрагента по ИНН и КПП, если
        такой будет найден, то обновит информацию по нему (информацию, к
        каким интеграционным аккаунтам относится данный контрагент, а
        также занесет в систему необходимые идентификаторы Диадок). В
        первую очередь обновляются поля у основной карточки ИА:
        Наименование, Краткое наименование, ИНН, КПП, ОГРН, и поля в
        сателлите ИА: Идентификатор ящика, Идентификатор ЭДО,
        Идентификатор организации.

> Для КА не является ИА обновится информация только в сателлите:
> Идентификатор ящика, Идентификатор ЭДО, Идентификатор организации,
> регион.

-   если по предыдущим двум проверка не будет найден контрагент, система
    создаст новую карточку контрагента, внеся в нее всю необходимую
    информацию (информацию, к каким интеграционным аккаунтам относится
    данный контрагент, а также занесет в систему необходимые
    идентификаторы Диадок и реквизиты организации).

<!-- -->

-   Обновить контрагентов -- при нажатии на кнопку для всех
    контрагентов, у которых заполнен идентификатор ящика, система
    выполняет по найденному идентификатору запрос в Диадок для получения
    информации, по полученным данным выполняет обновление реквизитов
    карточки контрагента в случае, если есть отличия в значениях
    реквизитов в TESSA и Диадок. В первую очередь обновляется информация
    по ИА. В основной карточке ИА обновляются поля: Наименование,
    Краткое наименование, ИНН, КПП, ОГРН. В полях сателлита КА
    обновляются: Идентификатор ящика, Идентификатор ЭДО, Идентификатор
    организации. Также выставляется связь контрагента и интеграционных
    аккаунтов.

Также на данной вкладке содержится информация по последней успешной
загрузке/обновлению контрагентов.

# Справочник контрагентов

Для возможности обмена с контрагентом документами через Диадок
необходимо для контрагента заполнить Идентификатор ЭДО.

Для просмотра/заполнения данных Диадок для контрагента необходимо на
тулбаре карточки нажать на кнопку «Диадок».

Редактирование данных Диадок для контрагента доступно только для
сотрудников, включенных в роль «Заполнение контрагентов Диадок».

Данные Диадок для контрагента:

<figure>
<img src="media/image14.png" style="width:6.49653in;height:1.98889in" />
<figcaption><p>Рисунок 13. Реквизиты контрагента Диадок</p></figcaption>
</figure>

-   Идентификатор ящика -- идентификатор ящика в Диадоке.

-   Идентификатор участника ЭДО -- идентификатор участника ЭДО в
    Диадоке.

-   Идентификатор организации -- идентификатор организации в Диадоке.

-   Регион -- регион, к которому относится организация, заполняется в
    случае, если в Диадоке для организации не указан регион. Данное поле
    обязательно для отправки формализованных документов контрагенту.
    Данное поле автоматически будет заполнено из Диадок при загрузке КА,
    но только при условии, что сама организация заполнила у себя Регион
    в реквизитах, иначе нужно написать партнеру и попросить его
    дозаполнить реквизиты.

-   Взаимодействует с интеграционными аккаунтами -- список
    интеграционных аккаунтов, с которыми у данного контрагента
    установлено партнерство (информация загружается автоматически из
    Диадока) и дата изменения статуса партнерства между КА и ИА.

## Запрос партнерства

Запрос партнёрства для контрагента можно осуществить 2-мя способами. При
наличии ИД ЭДО контрагента (вводится в диалоговом окне просмотра
информации Диадок), с которым хотим подружиться можно воспользоваться
кнопкой в левой панели «Отправить приглашение для обмена в Диадок».
Располагая только такими данными, как ИНН и КПП приглашаемого
контрагента и введя их в соответствующие поля, в левой панели
отобразится кнопка «Отправить приглашение для обмена в Диадок (по ИНН и
КПП)». Для типов контрагентов индивидуальный предприниматель и
физическое лицо необходим только ИНН (12 символов). При отправке
приглашения, введённые КПП и ИНН будут сверяться с БД Диадок.

# Интеграционные аккаунты

Интеграционный аккаунт -- это ящик Диадок, для которого должна
выполняться интеграция. Может быть подключено неограниченное количество
ящиков. Интеграция со всеми ИА выполняется от одной административной
учетной записи (указанной в карточке настроек интеграции), имеющей в
Диадоке доступ ко всем нужным ящикам.

Для добавления ИА необходимо открыть карточку контрагента, для которого
заполнена информация по Диадоку (как минимум идентификатор ящика Диадок)
и выставить флаг «Интеграционный аккаунт» в диалоговом окне (сателлите),
открываемом по кнопке «Диадок», расположенной на тулбаре карточки
контрагента.

Для ИА дополнительно доступна информация:

-   Основной аккаунт -- данный ИА используется по умолчанию для запросов
    к Диадок, не имеющих отношения к конкретной организации. Контролл
    появляется только при выставленном флаге «Интеграционный акканут», и
    может быть только один основной аккаунт на все ИА.

-   Корневое подразделение -- корневое подразделение из справочника
    подразделений, которое связано с данным интеграционным аккаунтом,
    используется для автоматического заполнения поля «Организация ЭДО»
    (организации, от имени которой должен отправиться документ). Система
    автоматически определит, в каком подразделении сотрудник, к какому
    корневому подразделению относится его подразделение и предзаполнит
    организацию в карточке документа.

-   Дата начала обмена -- модуль интеграции Диадок будет загружать
    только те документы, дата создания в Диадоке равна или больше
    указанной в данном поле (т.е. с помощью данного поля вводится
    ограничение, чтобы не загружать в систему старые документы).

-   Информация о синхронизации -- отображается информация, когда была
    выполнена последняя загрузка информации по документам из Диадока.

-   МЧД организации -- таблица для заполнения данных об МЧД, которые
    пользователи смогут использовать при подписании документов. Поля
    таблицы:

    -   Сотрудник -- ссылка на справочник сотрудников, указывается
        сотрудник, для которого добавляется информация об МЧД.

    -   Должность -- должность сотрудника, которая будет передана в
        Диадок при подписании документов с использованием данной МЧД.

    -   ИНН -- ИНН сотрудника.

    -   Ссылка на МЧД -- ссылка на карточку МЧД (при использовании
        дополнительного модуля по регистрации и отзыву МЧД).

    -   Начало действия -- дата начала действия доверенности.

    -   Окончание действия -- дата окончания действия доверенности.

    -   Статус МЧД -- не доступно для редактирования, заполняется
        автоматически, отображает статус регистрации МЧД в Диадоке
        (статус привязки в Диадоке к сотруднику). Возможные значения:
        Ожидает синхронизации, Привязана.

    -   Описание.

#  Настройка процессов/маршрутов

Преднастроенные процессы реализованы на подсистеме маршрутов и
визуальном конструкторе процессов Workflow Engine (далее - WFE),
дублируют функциональность и запускаются по кнопке в меню.

## Подписание и отправка Диадок

Информация по типовой функциональности маршрутов документов доступна по
ссылке <https://mytessa.ru/docs/4.0/adm/admin/routes/>

Информация о действиях в WFE, аналогичных по смыслу соответствующим
этапам подсистемы маршрутов, доступна по ссылке
<https://mytessa.ru/docs/4.0/dev/workflow/routes/>

Для данного этапа разработан отдельный этап маршрута и кубик WFE
«Подписание и отправка (Диадок)».

В этапе есть следующие настройки:

-   «Режим работы», выпадающий список значений:

    -   Отправить задание -- этап отправит задание;

    -   Вынести положительное решение -- без отправки задания этап
        выполнит те же действия, что выполняются при завершении задания
        положительным решением (Подписать);

    -   Вынести отрицательное решение -- без отправки задания этап
        выполнит те же действия, что выполняются при завершении задания
        отрицательным решением (Отказать).

При выполнении действий в режиме без отправки задания, в историю заданий
добавляется запись о выполненном действии.

-   «Без диалога выбора файла» -- флаг. Если при попытке завершения
    задания подписания в карточке документа только один не виртуальный
    файл, то будет подписан именно он. Если не виртуальных файлов более
    одного, то при снятом флаге пользователю выведется диалоговое окно
    для выбора, какой файл необходимо подписать и отправить в Диадок;
    при выставленном флаге будет подписан и отправлен первый попавшийся
    файл в указанной категории (необходимо на проекте настройками
    обеспечить, чтобы в указанной категории был только один файл).
    Актуально только для Исходящих документов Диадок (т.к. для входящих
    документов, даже если там много файлов, будет подписан именно тот,
    который изначально пришел из Диадок). Флаг применим только для
    режима «Отправить задание».

-   «Категория для подписания и отправки файла в Диадок» -- ссылка на
    справочник категорий, для выбора доступно только одно значение. Если
    значение указано, то подписание и отправка в Диадок исходящего
    документа осуществляется из этой категории. Если в нужной категории
    файлов несколько, то возьмется первый попавшийся.

-   При старте этапа, если установлен флаг «Изменять состояние при
    старте», в режиме «Отправить задание» состояние документа меняется
    на «На подписании». В остальных режимах при старте этапа смена
    состояния не выполняется.

-   При завершении задания вариантом «Подписать» или в режиме вынесения
    положительного решения:

    -   система открывает стандартное окно выбора сертификата для ЭП;

    -   далее выполняется отправка информации в Диадок. В зависимости от
        типа данного документа (входящий или исходящий) отправка
        выполняется в разных режимах, в соответствии с требованиями
        Диадок. Исключение -- документ, помещенный в пакет документов.
        Такой документ будет подписан, но отправлен только при отправке
        пакета. Отправка пакета документов описана в разделе 10.2;

    -   для входящего формализованного документа, требующего подписания,
        автоматически подписывается Извещение о получении тем же
        сертификатом, который пользователь выбрал при подписании, и
        отправляется вместе с информацией по подписанию;

    -   далее меняется состояние (только в случае, если выставлен флаг
        «Изменять состояние при завершении») и статус документа.

-   При завершении задания вариантом «Отказать» или в режиме вынесения
    отрицательного решения:

    -   для входящего документа:

        -   система формирует файл с данными по отказу в подписании (по
            требованиям Диадок, xml), открывает стандартное окно выбора
            сертификата для ЭП, ЭП накладывается на сформированный файл
            с информацией об отказе в подписании, после чего выполняется
            отправка информации в Диадок;

        -   для формализованного документа, требующего подписания,
            автоматически подписывается Извещение о получении тем же
            сертификатом, который пользователь выбрал при отклонении, и
            отправляется вместе с информацией по отказу в подписании;

        -   состояние меняется на «Аннулирован», статус меняется на
            «Отказано в подписи контрагенту»;

        -   при этом, в отличие от типового этапа подписания, не
            выполняется возврат на доработку, флаги «Вернуть при отказе»
            и «Не возвращать на доработку» не учитываются и ни на что не
            влияют (только в режиме «Отправить задание).

    -   для исходящего документа:

        -   в режиме вынесения отрицательного решения -- ничего не
            выполняется (не предполагается использование данного этапа в
            целях отказа в подписании для исходящих);

        -   в режиме отправки задания -- стандартное поведение, как в
            типовом этапе подписания;

        -   этап учитывает флаги \"Не возвращать на доработку\" и
            \"Вернуть при отказе\" и выполняет логику в соответствии с
            типовой логикой этапа Подписание (только в режиме «Отправить
            задание).

Добавленный комментарий при отказе в подписании фиксируется:

-   Исходящие документы:

    -   в историю операций. Текст добавляется в строку с описанием
        операции Диадок;

    -   в карточке документа в баллон, расположенный справа, строка
        после статуса Диадок.

-   Входящие документы:

    -   в истории заданий фиксируется комментарий для ЭП (при вынесении
        отрицательного решения без задания);

    -   в истории заданий фиксируется комментарий, указанный в задании
        (при завершении задания вариантом «Отказать»).

## Отправка пакета документов

Отправка пакета документов реализована вторичным процессом «Отправка
пакета документов».

Для добавления документа в пакет необходимо на тулбаре карточки нажать
на кнопку «Диадок» и выбрать вариант «Добавить в пакет», или в карточке
пакета документов в соответствующем поле выбрать нужные карточки
документов и нажать на «Добавить».

Перед отправкой пакета каждый документ в пакете должен быть подписан при
помощи этапа «Подписание и отправка (Диадок)».

При нажатии на кнопку запуска процесса производится проверка доступности
данного процесса:

-   у документов статус обработки - \"На отправке\";

-   все документы в составе этого пакета уже имеют сателлит;

-   в сателлитах есть идентификатор Файла (FileID), идентификатор
    Подписи (SignatureID), т.е. все документы были подписаны и
    подготовлены для отправки;

-   в сателлите у всех документов указано направление - \"Исходящий\".

Кроме этого сверяется, что у всех документов пакета один КА и одна
организация ЭДО (т.е. один ИА), и если это не так, процесс не
запускается и выдается сообщение об ошибке.

## Аннулирование

Для данного этапа разработан отдельный этап маршрута и кубик WFE
«Аннулирование (Диадок)».

\"Режим работы\" -- выпадающий список значений:

-   Отправить задание -- этап отправит задание с вариантами завершения
    «Аннулировать» и «Отказать».

-   Вынести положительное решение -- этап без отправки задания. Будут
    выполнены те же действия, что выполняются при завершении задания
    положительным решением (Аннулировать). Формируется и подписывается
    соглашение об аннулировании, сохраняется файл ЭП в карточке,
    отправляется в Диадок.

> Если запрос аннулирования направлен из TESSA в Диадок, то обязателен
> ввод комментария в задании (если режим с отправкой задания) или в
> диалоге (если режим без отправки задания), который будет передан в
> Диадок.
>
> Если запрос поступил из Диадока в TESSA, то ввод комментария не
> обязателен, при его вводе информация в Диадок не отправляется.

-   Вынести отрицательное решение -- этап без отправки задания. Будут
    выполнены те же действия, что выполняются при завершении задания
    отрицательным решением (Отказать). В данном случае ввод комментария
    не обязателен, при его вводе информация в Диадок не отправляется.

Если документ подписан обеими сторонами и документооборот завершен, то
при старте процесса аннулирования состояние карточки меняется на «На
аннулировании», статус обработки Диадок на «На отправке».

Если документ еще не подписан контрагентом, то при старте процесса
аннулирования состояние карточки меняется на «Аннулирован».

При поступлении запроса из Диадока в TESSA в карточке меняется статус
Диадок на «Требуется аннулирование», и после вынесения положительного
решения состояние карточки меняется на «Аннулирован», а статус обработки
Диадок «На отправке».

При аннулировании формализованного документа автоматически подписывается
Извещение о получении тем же сертификатом, который пользователь выбрал
при подписании, и отправляется вместе с информацией по аннулированию.

Добавленный комментарий при аннулировании фиксируется:

-   в карточке документа в баллон, расположенный справа, при поступлении
    запроса на аннулирование для входящего документа, который еще не
    подписан;

-   в карточке документа в баллон, расположенный справа, при поступлении
    запроса на аннулирование для входящего/исходящего документа;

-   в истории заданий при отправлении запроса на аннулирование или
    вынесении положительного решения (с заданием и без отправки
    задания).

## Подписание извещения о получении

При поступлении входящих формализованных документов «Счет-фактура» и
«Универсальный передаточный документ» с функцией «Счет-фактура» и
«Счет-фактура и передаточный документ» требуется отправка извещения о
получении (далее - ИоП) для завершения документооборота. Для других
формализованных документов отправка извещений возможна, но не
обязательна.

Отправка ИоП реализована вторичным процессом «Отправка извещения о
получении (Диадок)».

При поступлении формализованного документа, который имеет статус
«Требуется отправка извещения» или «Ожидается подпись контрагента.
Ожидается извещение о получении», присутствует возможность запускать
процесс из меню карточки или привязать процесс (отправляющий задание на
подписание ИоП) в настройках интеграции и запускать при поступлении
документов, которые поддерживают отправку ИоП.

## Повторная отправка при сбое

Возможны два вида сбоя:

-   Сбой отправки -- не удалось отправить в Диадок, например, нет связи
    с Диадоком.

-   Сбой доставки -- документ отправлен, но Диадок вернул ошибку.

Повторная отправка реализована вторичным процессом «Отправить повторно
(Диадок)». Процесс доступен только в случае, если Статус обработки «Сбой
отправки» или «Сбой доставки».

### Сбой отправки

Во вторичном процессе сценарием вызывается нужный механизм:

-   Исходящий документ -- отправляется документ, данные для отправки в
    Диадок формируются заново по реквизитам сателлита.

-   Входящий документ -- если документ уже подписан (есть вторая ЭП и
    нет в сателлите xml отказа в подписи), то отправляется его ЭП. Если
    было отказано в подписании, уже получен xml, но не удалось
    отправить, тогда вторичный процесс повторной отправки его отправит
    через активную операцию. Если в момент отказа в подписи не удалось
    получить xml (например, не было связи), то задание подписания не
    завершится и повторная отправка в этом случае не требуется.

### Сбой доставки

В случае, если Диадок вернул ошибку и статус обработки \"Сбой
доставки\", у пользователя есть возможность выбора, или повторно
отправить без переподписания, или заново подписать и отправить.

Отправить без переподписания:

-   Исходящий документ -- отправляется документ, при этом данные для
    отправки в Диадок формируются заново. Тот же вторичный процесс,
    который описан в п.10.5.1.

-   Входящий документ -- функциональность не предусмотрена.

Отправить с переподписанием -- входящий и исходящий документ направить
на подписание и после вынесения положительного решения он будет
отправлен в Диадок.

По событию «Сбой доставки» можно запустить процесс или сменить состояние
карточки на «На обработке».

### Массовая повторная отправка

В представлениях «Сбой отправки документов» и «Сбой доставки документов»
в меню присутствует тайл «Отправить повторно (Диадок)», при нажатии на
который выполняется повторная отправка (вызывается вторичный процесс)
для каждого подходящего по условиям документа с учетом фильтрации. Т.е.
если задать условия фильтрации и запустить повторную отправку, то
отправлены будут только те документы, которые попали под заданные
параметры фильтрации.

#  Работа с МЧД

Загрузку списка сотрудников организации (для каждой организации), у
которых есть актуальная МЧД, выполняет плагин Chronos, описанный в
разделе 3.7. Отдельный плагин, описанный в разделе 3.8, выполняет
отправку в Диадок информации по МЧД.

Если у подписанта документа есть актуальная МЧД в организации, указанной
в сателлите, и имеющая статус «Привязана», то при вынесении
положительного решения в режиме задания или без задания открывается
диалог выбора МЧД. Также диалог открывается, если для подписания ФД
требуется указать «Дату приемки».

Также, при поступлении входящего документа, требующего подписания, при
отказе в подписании открывается диалог выбора МЧД.

Реквизиты диалога (блоки отображаются в зависимости от того, требуется
подписание с помощью МЧД или указания даты приемки):

-   МЧД -- для выбора доступны строки таблицы МЧД организации, из
    карточки соответствующей организации, относящиеся к подписанту. Если
    у подписанта только одна МЧД, то поле пред заполнено.

-   Подписать без использования МЧД -- при выставлении данного флага
    очищается и становится недоступным для редактирования реквизит
    «МЧД».

-   «Дата приемки» -- выбор даты из календаря.

Завершение диалога вариантом «ОК» подтверждает выбор. Вариант «Отмена»
отменяет и закрывает диалог, но задание подписания остается активным.

При вынесении положительного решения аннулирования документа в режиме
задания или без задания, открывается диалог выбора МЧД. Диалог
отображается только в том случае, если у сотрудника, выносящего решение
по аннулированию, есть актуальная МЧД в организации, указанной в
сателлите.

#  Формализованные документы

Формализованные документы создаются нажатием на тулбаре кнопки «Диадок»
в карточке документа и выбором соответствующего вида документа. В
сателлите документа необходимо заполнить реквизиты, подписать и
отправить. Подписание и отправка документов описана в разделе 10.1.

# Корректировочные и исправительные формализованные документы

Создание корректировочных и исправительных документов происходит на
основании формализованной Счет-фактуры и УПД с функциями «Счет фактура»
и «Счет-фактура и передаточный документ». Создается копия с тем же типом
документа.

## Создание корректировки/исправления и запрос уточнений

-   Запрос уточнения реализован вторичным процессом «Запросить уточнение
    «Диадок». Если документ в статусе Диадок «Документооборот завершен»,
    то при нажатии на кнопку в меню открывается диалог с необходимостью
    указать обязательный комментарий и выбрать вариант завершения «ОК» и
    «Отмена». При подтверждении действия отправляется запрос уточнения в
    Диадок.

-   Создание исправления реализовано вторичным процессом «Создать
    исправление (Диадок)». При нажатии на кнопку запуска процесса,
    расположенную в меню системы:

    -   Создается новая карточка, являющаяся полной копией текущей, но
        без переноса файлов.

    -   После сохранения карточки пользователем автоматически создается
        сателлит нужного вида документа.

    -   В сателлите есть дополнительные поля:

        -   «Исходный документ» -- ссылка на карточку исходного
            формализованного документа, заполнится автоматически;

        -   «Корректировочные и исправительные документы» --
            представление, которое отображает все корректировки и
            исправления включая текущую карточку (если это корректировка
            или исправление).

    -   Автоматически проставляются перекрестные ссылки.

    -   Если исходный документ содержится в каком-либо пакете, то
        созданный исправительный документ автоматически включается в тот
        же пакет. Если исходный документ не был включен в пакет, то
        создается новый пакет и исходный документ вместе с созданным
        исправлением помещаются в него.

<!-- -->

-   Создание корректировки реализовано вторичным процессом «Создать
    корректировку (Диадок») и работает аналогично процессу создания
    исправления.

### Отправка корректировки/исправления в Диадок

Процесс отправки корректировочных/исправительных документов работает по
этапу/кубику «Подписание и отправка (Диадок)». После успешной отправки
документа в Диадок:

-   меняется статус у всех связанных документов, которые связаны
    исходным документом, включая сам исходный;

-   во всех связанных документах, кроме последнего актуального
    документа, в карточке документа в баллоне, расположенном справа,
    отображается ссылка на актуальный документ.

### Получение корректировки/исправления из Диадока

За получение корректировки/исправления из Диадока отвечает плагин
синхронизации, обрабатывая событие «Поступил запрос уточнения по ФД».

В сателлите созданного корректировочного/исправленного документа
отображается ссылка на первоначальный документ, а в исходном документе
(документ, из которого создана корректировка/исправление), отображается
ссылка на текущий поступивший документ.

Если документ, требовавший корректировки/исправления, содержался в
каком-либо пакете, то полученный исправительный документ автоматически
включается в тот же пакет. Если исходный документ не был включен в
пакет, то создается новый пакет и исходный документ вместе с созданным
исправлением помещаются в него. Исправленные/скорректированные документы
в пакете подсвечиваются серым цветом.

## Создание формализованного документа из XML

![](media/image15.png){width="2.0194444444444444in"
height="1.9270833333333333in"} Формализованные документы из файла,
формата \*.xml, создаются путём сохранения основной карточки документа и
нажатием на тулбаре кнопки «Создать документ из xml». В развёрнутом
списке появится возможность выбрать файл и учесть его тип. В момент
загрузки файла, происходит проверка соответствия выбранному типу ФД. В
случае несовпадения, выводится ошибка с сообщением о несоответствии
выбираемого и загружаемого типа документа без подробного описания.

Рисунок . Выбор типа документа

Метод принимает в качестве параметров:

  -------------------------------------------------------------------------
  Параметр                Тип данных                Описание
  ----------------------- ------------------------- -----------------------
  Бинарное представление  byte\[\] / MemoryStream   Бинарное представление
  файла, содержащего ФД в                           файла или же поток
  формате xml                                       чтения файла, на основе
                                                    которого будет создан
                                                    сателлит и заполнены
                                                    реквизиты документа

  Идентификатор карточки  Guid                      Уникальный
                                                    идентификатор карточки,
                                                    к которой будет создан
                                                    сателлит Диадок

  Объект валидации        ValidationResultBuilder   Объект для построения
                                                    результата валидации
  -------------------------------------------------------------------------

Метод проверяет, что для карточки включен флаг «Участвует в
документообороте Диадок», затем отсутствие созданного для карточки
сателлита Диадок, затем корректность самого файла. Далее метод
отправляет запрос в Диадок, чтобы из файла получить объект Diadoc SDK C#
с реквизитами формализованного документа. Далее по этому объекту
определяется вид формализованного документа, создается сателлит с нужным
видом и функций (если это УПД). Метод работает с ValidationResultBuilder
и заполняет ошибки в случае их возникновения.

Пример вызова данного метода из кода (C#):

var diadocCreateSatelliteFromXml =
this.UnityContainer.Resolve\<IDiadocCreateSatelliteFromXmlService\>();
//Достаем из контейнера зависимостей сервис
IDiadocCreateSatelliteFromXmlService

await diadocCreateSatelliteFromXml.CreateFormalizedDocumentFromXmlAsync(

CardID,

content,

ValidationResult,

CancellationToken); //Вызываем метод
CreateFormalizedDocumentFromXmlAsync, передав ему соответствующие
параметры

###  Создание корректировки и исправления из XML

В случае, если требуется отправить корректировку/исправление по
документу, созданному из файла формата .xml, реализован публичный метод,
который принимает в качестве параметров:

  -------------------------------------------------------------------------
  Параметр                Тип данных                Описание
  ----------------------- ------------------------- -----------------------
  Бинарное представление  byte\[\] / MemoryStream   Бинарное представление
  файла, содержащего ФД в                           файла или же поток
  формате xml                                       чтения файла, на основе
                                                    которого будет создан
                                                    сателлит и заполнены
                                                    реквизиты документа

  Идентификатор карточки  Guid                      Уникальный
                                                    идентификатор карточки,
                                                    к которой будет создан
                                                    сателлит Диадок

  Идентификатор карточки  Guid                      Идентификатор основной
                                                    карточки, на основании
                                                    которой будет создана
                                                    корректировка или
                                                    исправление

  Объект валидации        ValidationResultBuilder   Объект для построения
                                                    результата валидации
  -------------------------------------------------------------------------

Метод проверяет, что для карточки включен флаг «Участвует в
документообороте Диадок», затем отсутствие созданного для карточки
сателлита Диадок, затем корректность самого файла. Далее метод
отправляет запрос в Диадок, чтобы из файла получить объект Diadoc SDK C#
с реквизитами корректировки или исправления. Далее по этому объекту
определяется вид корректировки или исправления, создается сателлит с
нужным видом. Метод работает с ValidationResultBuilder и заполняет
ошибки в случае их возникновения.

#  Создание новой карточки для существующего сателлита

Данная возможность предусмотрена с целью возможности отвязать сателлит
от карточки, созданной по интеграции с Диадок, и привязать к другой
карточке (другому типу документа). Это может быть необходимо в тех
случаях, когда из поступающих из Диадока документов мы не может
однозначно определить, какой тип документа необходимо создавать, и
данное решение будет принимать пользователь.

## Создание новой карточки для существующего сателлита

Для типов документов, у которых включена интеграция с Диадок, в меню
отображается пункт «Создать карточку другого типа», который запускает
процесс. По умолчанию процесс не настроен ни для каких документов. Тайл
процесса имеет видимость и зависит от настроек процесса и скрыт для
документов, у которых направление не является «Входящий».

При нажатии на тайл открывается диалог с выбором типа документа, который
необходимо создать. В диалоге для выбора доступны все типы, для которых
включен обмен с Диадоком. После выбора нужного типа документа создается
карточка нужного типа (но не сохраняется на сервере), при этом по
маппингу автозаполнены реквизиты созданной карточки. При первом успешном
сохранении отвязывается сателлит от текущей карточки и привязывается к
новой созданной карточке. В новую карточку переносятся файлы, а также
реквизит dci.CreationDate, если и в старой и в новой карточке была эта
секция. Также меняются ссылки в таблице связей Пакетов, если они были.
Старая карточка удаляется.

## Перепривязка сателлита к существующей карточке

Для типов документов, у которых включена интеграция с Диадок, в меню
отображается пункт «Перенести данные Диадок в другую карточку», который
запускает процесс. По умолчанию процесс не настроен ни для каких
документов. Тайл процесса имеет видимость и зависит от настроек процесса
и скрыт для документов, у которых направление не является «Входящий».

При нажатии на тайл открывается диалог с выбором документов без
сателлита, относящихся к типу документа, для которого выставлен флаг
интеграции с Диадок. В диалоге для выбора доступны все типы, для которых
включен обмен с Диадоком и отсутствует сателлит. После выбора нужного
типа документа создается карточка нужного типа (но не сохраняется на
сервере). При первом успешном сохранении отвязывается сателлит от
текущей карточки и привязывается к выбранной карточке. Старая карточка
удаляется.

#  Файл визуализации и штамп ЭП

## Файл визуализации

Если формализованный документ не отправлен, то на тулбаре в меню
«Диадок» доступен пункт «Загрузить PDF». При нажатии создается шаблон
документа. В случае наличия файла визуализации, при нажатии кнопки
прикладывается новая версия к существующему файлу. Созданный файл
добавляется в категорию, которая указана в карточке настроек интеграции
с Диадок в поле «Категория загруженных файлов визуализации».

Для неформализованных документов пункт меню «Загрузить PDF» доступен
только для отправленных и полученных документов.

Также загрузка файла визуализации реализована отдельным этапом «Загрузка
визуализации» типа «Сценарий» (Рисунок 15). Данный этап можно вставить в
любую часть процесса (это может быть удобно, чтобы перед формированием
первого задания по процессу, например, задания согласования, уже
сформировать файл визуализации формализованного документа). Он будет
выполнен, если есть сателлит любого вида формализованного документа,
иначе он будет пропущен. Загрузку файлов визуализации из Диадок
осуществляет плагин Chronos. Описание работы плагина в разделе 3.5.

<figure>
<img src="media/image16.png" style="width:6.24768in;height:5.62992in"
alt="Изображение выглядит как текст, снимок экрана, программное обеспечение, веб-страница Автоматически созданное описание" />
<figcaption><p>Рисунок 15. Этапы маршрута «Загрузка визуализации» и
«Конвертация Диадок»</p></figcaption>
</figure>

## Конвертация файла и простановка штампов ЭП

Если на проекте не используется загрузка файлов визуализации из Диадока,
то при необходимости возможно формирование штампов ЭП в TESSA.

Для конвертирования основного файла в формат .pdf с простановкой штампов
ЭП реализован этап маршрута и кубик WFE «Конвертация для Диадок»
(Рисунок 15). На рисунке так же показана возможность определить
категорию для сконвертированного файла. Таким образом конвертацию файла
можно реализовать отдельным процессом и запуском через тайл (кнопку) или
включить как этап в маршрут. Этап создает операцию конвертации для
плагина Chronos. Описание работы плагина Chronos в разделе 3.6.

Кол-во штампов будет соответствовать количеству электронных подписей по
ходу процесса подписания и отправки документа на момент формирования (1
или 2 штампа). Например, для НД без требования подписи получателя будет
один штамп - отправителя. При конвертации НД, плагин возьмёт основной
файл и создаст на основе него сконвертированный с простановкой штампов.
При конвертации ФД штамп проставляется на сконвертированный файл,
который представляет собой файл визуализации с нанесёнными ЭП и
штампами. Название сконвертированного файла соответствует для НД
основному файл, а для ФД файлу визуализации. В истории заданий появится
запись с указанием названия файла. В случае отсутствия необходимых
файлов для процесса, предусмотрен вывод соответствующего сообщения в
колонке «Результат» истории заданий. Версионность файлов не
предусмотрена, т.е. каждый раз будет создаваться новый файл.

В настройки этапа добавлен реквизит «Расположить сконвертированный файл
в категории», который позволяет указать одну категорию из списка
категорий.

Штамп визуализации ЭП имеет размер на странице А4: высота 36 мм, ширина
83 мм.

Расположен внизу последней страницы с выравниванием по центру. Если
штампа два, то они располагаются рядом с выравниванием по центру. Пример
визуализации ЭП расположен на рисунке ниже (Рисунок 16).

<figure>
<img src="media/image17.png" style="width:3.81712in;height:1.69291in"
alt="Изображение выглядит как текст, снимок экрана, Шрифт, Цвет электрик Автоматически созданное описание" />
<figcaption><p>Рисунок 16. Визуализация ЭП</p></figcaption>
</figure>

Для работы конвертации в файле app-stampImagePath.json нужно указать
путь к файлу штампа.

Процесс конвертации потребует настройки веб-сервиса Jinni, который
используется для выполнения операций над документами, такими
как распознавание текста в файле и конвертация файла в pdf. Настойка
Jinni описана [в руководстве Tessa на официальном
сайте](https://mytessa.ru/docs/4.0/adm/install/jinni/).

#  Тестирование

Для возможности тестирования модуля необходимо выполнить следующие
действия:

1.  Создать аккаунт и зарегистрироваться на сервисе Контур:

-   Создать аккаунт на сайте экосистемы Контур
    <https://auth.kontur.ru/>. Перейдя по ссылке необходимо нажать
    «Зарегистрироваться»;

-   Заполнить поля почта, пароль. Далее перейти в входящее письмо от
    сервиса, чтобы подтвердить адрес эл. почты и завершить регистрацию;

-   Вернитесь на первоначальную страницу, по адресу, указанному выше.
    Прейдите на кладку окна для входа по паролю. Осуществите вход по
    паролю, логину;

-   В адресной строке браузера введите и перейдите по ссылке
    <https://diadoc-widget.kontur.ru/easyregistration>. Перейдите по
    кнопке с названием «Тестовый ящик. Познакомьтесь с сервисом.
    Бесплатно...»:

2.  Настройки тестового ящика в Контур.Диадок

-   Первый вход в ЛК Диадок создаст рандомный тестовый ящик. В хедере
    главной страницы ЛК можно увидеть название вашей организации
    («Тестовая организация № ххх»). Развернув список, состоящий пока из
    1 организации и нажав на ссылку «Список и добавление организаций»
    можно добавить другие организации;

-   Используйте данные одной из организаций для создания интеграционного
    аккаунта в Тесса;

-   Данные организации, такие как ИД ЭДО, ИНН/КПП можно посмотреть в
    меню «Настройки»-«Реквизиты организации»;

-   Для подписания документов всем пользователям по умолчанию доступен
    тестовый служебный сертификат, поэтому можно подписывать любые
    документы без дополнительных настроек. Для работы подписания из
    TESSA необходима тестовая КЭП;

-   Обратите внимание, что документы из тестового ящика не являются
    юридически значимыми и помечаются в системе, как тестовые;

-   Полезные ссылки:

> Справка по продукту Контур.Диадок: <https://support.kontur.ru/diadoc>
>
> API, Глоссарий продукта Контур.Диадок
> <https://developer.kontur.ru/docs/diadoc-api/index.html>

3.  Получить тестовую КЭП:

-   Для выпуска тестового КЭП необходимо заполнить анкету, расположенную
    по ссылке: https://disk.skbkontur.ru/index.php/s/Cc48Ee592YA3TZd и
    отправить в ответном письме;

-   В письме и в анкете необходимо указать ИНН и КПП тестовой
    организации (\"Настройки\" -- \"Реквизиты организации\"). Если в
    анкете будут указаны реквизиты вашей действующей организации, а не
    тестовой, то в выпуске тестового КЭП будет отказано;

-   Обратите внимание, что сертификат может быть привязан только к
    пользователю, не имеющему доступ в ящики реальных организаций;

-   Стандартный срок действия тестового сертификата -- 15 месяцев;

-   В ответ будет отправлена тестовая КЭП и инструкция по установке;

-   Для управления тестовой КЭП можно воспользоваться сервисом
    КриптоПро;

После выполнения указанных действий можно приступать к тестированию, при
условии, что модуль уже установлен и настроен согласно данной
инструкции.
